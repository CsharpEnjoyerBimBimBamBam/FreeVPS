name: MacOS Virtual Machine

on:
  workflow_dispatch:

jobs:
  build:
    name: MacOS Build
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v2

      - name: Setting Up the MacOS Environment
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
          MAC_USER_PASSWORD: ${{ secrets.MAC_USER_PASSWORD }}
          VNC_PASSWORD: ${{ secrets.VNC_PASSWORD }}
          MAC_REALNAME: ${{ secrets.MAC_REALNAME }}
        run: |
          echo "Running macos-run.sh..."
          chmod +x macos-run.sh
          ./macos-run.sh "$MAC_USER_PASSWORD" "$VNC_PASSWORD" "$NGROK_AUTH_TOKEN" "$MAC_REALNAME"

      - name: Show ngrok public TCP URL
        run: |
          echo "Waiting a few seconds for ngrok to initialize..."
          sleep 5
          cat ngrok.log | grep -Eo 'tcp://[0-9a-zA-Z:.]+'
